<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-button: var(--tg-theme-button-color, #40a7e3);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f3f2f7);
        }
        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
        }
        .tab-active {
            background-color: var(--tg-button);
            color: var(--tg-button-text);
            border-color: var(--tg-button);
        }
        .tab-inactive {
            background-color: var(--tg-secondary-bg);
            color: var(--tg-text);
            border-color: var(--tg-secondary-bg);
        }
        .order-card {
            background-color: var(--tg-secondary-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .order-card:hover {
            transform: translateY(-2px);
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--tg-bg);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 50;
        }
        .modal-content-grid {
            display: grid;
            grid-template-columns: max-content 1fr;
            gap: 8px 16px;
        }
        .modal-content-grid dt {
            font-weight: 600;
            color: var(--tg-hint);
        }
        .modal-content-grid dd {
            word-break: break-word;
        }
        .loader {
            border: 4px solid var(--tg-secondary-bg);
            border-top: 4px solid var(--tg-button);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="container mx-auto">
        <h1 class="text-2xl font-bold mb-4">Заказы</h1>

        <!-- Вкладки -->
        <div class="flex space-x-2 mb-4 border-b border-[var(--tg-secondary-bg)] pb-2">
            <button data-status="Новый" class="tab-button tab-active px-4 py-2 rounded-lg font-semibold text-sm">Новые</button>
            <button data-status="В работе" class="tab-button tab-inactive px-4 py-2 rounded-lg font-semibold text-sm">В работе</button>
            <button data-status="Завершен" class="tab-button tab-inactive px-4 py-2 rounded-lg font-semibold text-sm">Завершенные</button>
        </div>

        <!-- Список заказов -->
        <div id="orders-list">
            <!-- Карточки заказов будут здесь -->
        </div>

        <!-- Загрузчик -->
        <div id="loader" class="loader hidden"></div>
        <p id="loading-text" class="text-center" style="color: var(--tg-hint);"></p>

    </div>

    <!-- Модальное окно -->
    <div id="modal-backdrop" class="modal-backdrop hidden"></div>
    <div id="modal" class="modal hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 id="modal-title" class="text-xl font-bold">Детали заказа</h2>
            <button id="modal-close-btn" class="text-2xl font-bold">&times;</button>
        </div>
        <div id="modal-content">
            <!-- Детали заказа будут здесь -->
        </div>
        <div id="modal-footer" class="mt-6 flex justify-end space-x-4">
            <!-- Кнопки управления заказом будут здесь -->
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();

            // ИСПРАВЛЕНИЕ: Вставьте ваш URL от ngrok сюда
            const API_BASE_URL = "https://ea8d21bfaa8b.ngrok-free.app";

            const state = {
                initData: tg.initData,
                currentStatus: 'Новый',
                currentPage: 1,
                isLoading: false,
                orders: []
            };

            const ordersList = document.getElementById('orders-list');
            const loader = document.getElementById('loader');
            const loadingText = document.getElementById('loading-text');
            const tabButtons = document.querySelectorAll('.tab-button');
            const modal = document.getElementById('modal');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalFooter = document.getElementById('modal-footer');


            // --- Функции API ---
            async function fetchApi(endpoint, options = {}) {
                if (!state.initData) {
                    tg.showAlert('Ошибка: данные для авторизации отсутствуют.');
                    throw new Error('InitData is missing');
                }
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': state.initData,
                        ...options.headers,
                    },
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                return response.json();
            }

            async function loadOrders(status, page = 1) {
                if (state.isLoading) return;
                state.isLoading = true;
                loader.classList.remove('hidden');
                loadingText.textContent = 'Загрузка заказов...';
                ordersList.innerHTML = '';

                try {
                    const data = await fetchApi(`/api/orders?status=${status}&page=${page}&limit=10`);
                    state.orders = data.orders;
                    renderOrders(data.orders);
                    if (data.orders.length === 0) {
                        loadingText.textContent = 'Заказов в этой категории нет.';
                    } else {
                        loadingText.textContent = '';
                    }
                } catch (error) {
                    console.error('Failed to fetch orders:', error);
                    loadingText.textContent = `Ошибка загрузки: ${error.message}.`;
                    tg.showAlert(`Ошибка загрузки: ${error.message}`);
                } finally {
                    state.isLoading = false;
                    loader.classList.add('hidden');
                }
            }

            async function updateOrderStatus(orderId, newStatus) {
                tg.showPopup({
                    title: 'Подтверждение',
                    message: `Вы уверены, что хотите изменить статус заказа №${orderId} на "${newStatus}"?`,
                    buttons: [
                        { id: 'ok', type: 'default', text: 'Да' },
                        { id: 'cancel', type: 'cancel', text: 'Отмена' },
                    ]
                }, async (buttonId) => {
                    if (buttonId === 'ok') {
                        try {
                            tg.showLoading();
                            await fetchApi(`/api/order/${orderId}/status`, {
                                method: 'POST',
                                body: JSON.stringify({ status: newStatus })
                            });
                            tg.showAlert(`Статус заказа №${orderId} успешно изменен.`);
                            closeModal();
                            loadOrders(state.currentStatus); // Обновляем список
                        } catch (error) {
                            console.error('Failed to update order status:', error);
                            tg.showAlert(`Ошибка обновления: ${error.message}`);
                        } finally {
                            tg.hideLoading();
                        }
                    }
                });
            }


            // --- Функции рендеринга ---
            function renderOrders(orders) {
                ordersList.innerHTML = orders.map(order => `
                    <div class="order-card" data-order-id="${order.order_id}">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-lg">Заказ №${order.order_id}</p>
                            <p class="text-sm" style="color: var(--tg-hint);">${new Date(order.created_at).toLocaleString('ru-RU')}</p>
                        </div>
                        <p>Тип: ${order.order_type}</p>
                        <p>Telegram: ${order.user_telegram || 'Не указан'}</p>
                    </div>
                `).join('');

                document.querySelectorAll('.order-card').forEach(card => {
                    card.addEventListener('click', () => openModal(card.dataset.orderId));
                });
            }

            function formatDetailsForDisplay(details) {
                const keyMap = {
                    'gender': '👤 Пол клиента', 'recipient': '🎁 Для кого', 'sender_role': '👥 От кого',
                    'occasion': '🎉 Повод', 'years_together': '💞 Лет вместе', 'has_children': '👨‍👩‍👧‍👦 Дети',
                    'song_style': '🎶 Стиль песни', 'wishes': '✍️ Пожелания',
                    'email': '📧 Email', 'phone': '📱 Телефон', 'telegram': '✈️ Telegram', 'source': '📍 Источник'
                };
                let html = '<dl class="modal-content-grid">';
                for (const key in details) {
                    if (keyMap[key] && details[key]) {
                        html += `<dt>${keyMap[key]}</dt><dd>${details[key]}</dd>`;
                    }
                }
                html += '</dl>';
                return html;
            }

            async function openModal(orderId) {
                modalTitle.textContent = `Загрузка заказа №${orderId}...`;
                modalContent.innerHTML = '<div class="loader"></div>';
                modalFooter.innerHTML = '';
                modal.classList.remove('hidden');
                modalBackdrop.classList.remove('hidden');

                try {
                    const order = await fetchApi(`/api/order/${orderId}`);
                    modalTitle.textContent = `Детали заказа №${order.order_id}`;

                    let contentHtml = `
                        <p class="mb-4"><strong style="color: var(--tg-hint);">Статус:</strong> ${order.status}</p>
                        ${formatDetailsForDisplay(order.details)}
                    `;
                    modalContent.innerHTML = contentHtml;

                    let footerHtml = '';
                    if (order.status === 'Новый') {
                        footerHtml += `<button data-order-id="${order.order_id}" data-new-status="В работе" class="status-btn tab-active px-4 py-2 rounded-lg font-semibold">Взять в работу</button>`;
                    }
                    if (order.status === 'В работе') {
                        footerHtml += `<button data-order-id="${order.order_id}" data-new-status="Завершен" class="status-btn tab-active px-4 py-2 rounded-lg font-semibold">Завершить</button>`;
                    }
                    modalFooter.innerHTML = footerHtml;

                    document.querySelectorAll('.status-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            updateOrderStatus(btn.dataset.orderId, btn.dataset.newStatus);
                        });
                    });

                } catch (error) {
                    console.error('Failed to fetch order details:', error);
                    modalContent.innerHTML = `<p>Ошибка загрузки деталей заказа: ${error.message}</p>`;
                }
            }

            // --- Обработчики событий ---\
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const status = button.dataset.status;
                    if (state.currentStatus === status) return;

                    tabButtons.forEach(btn => {
                        btn.classList.remove('tab-active');
                        btn.classList.add('tab-inactive');
                    });
                    button.classList.add('tab-active');
                    button.classList.remove('tab-inactive');

                    state.currentStatus = status;
                    state.currentPage = 1;
                    loadOrders(status);
                });
            });

            function closeModal() {
                modal.classList.add('hidden');
                modalBackdrop.classList.add('hidden');
            }

            modalCloseBtn.addEventListener('click', closeModal);
            modalBackdrop.addEventListener('click', closeModal);

            // --- Инициализация ---
            if (!state.initData) {
                loadingText.textContent = "Ошибка: не удалось получить данные для инициализации. Пожалуйста, откройте панель через бота.";
                tg.showAlert("Ошибка: не удалось получить данные для инициализации.");
                return;
            }

            loadOrders(state.currentStatus);
        });
    </script>

</body>
</html>
