<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-button: var(--tg-theme-button-color, #40a7e3);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f3f2f7);
        }
        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
        }
        .tab-active {
            background-color: var(--tg-button);
            color: var(--tg-button-text);
            border-color: var(--tg-button);
        }
        .tab-inactive {
            background-color: var(--tg-secondary-bg);
            color: var(--tg-text);
            border-color: var(--tg-secondary-bg);
        }
        .order-card {
            background-color: var(--tg-secondary-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .order-card:hover {
            transform: translateY(-2px);
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--tg-bg);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 50;
        }
        .modal-content-grid {
            display: grid;
            grid-template-columns: max-content 1fr;
            gap: 8px 16px;
        }
        .modal-content-grid dt {
            font-weight: 600;
            color: var(--tg-hint);
        }
        .modal-content-grid dd {
            word-break: break-word;
        }
        .loader {
            border: 4px solid var(--tg-secondary-bg);
            border-top: 4px solid var(--tg-button);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="container mx-auto">
        <h1 class="text-2xl font-bold mb-4">–ó–∞–∫–∞–∑—ã</h1>

        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="flex space-x-2 mb-4 border-b border-[var(--tg-secondary-bg)] pb-2">
            <button data-status="–ù–æ–≤—ã–π" class="tab-button tab-active px-4 py-2 rounded-lg font-semibold text-sm">–ù–æ–≤—ã–µ</button>
            <button data-status="–í —Ä–∞–±–æ—Ç–µ" class="tab-button tab-inactive px-4 py-2 rounded-lg font-semibold text-sm">–í —Ä–∞–±–æ—Ç–µ</button>
            <button data-status="–ó–∞–≤–µ—Ä—à–µ–Ω" class="tab-button tab-inactive px-4 py-2 rounded-lg font-semibold text-sm">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
        <div id="orders-list">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
        </div>

        <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
        <div id="loader" class="loader hidden"></div>
        <p id="loading-text" class="text-center" style="color: var(--tg-hint);"></p>

    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="modal-backdrop" class="modal-backdrop hidden"></div>
    <div id="modal" class="modal hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 id="modal-title" class="text-xl font-bold">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h2>
            <button id="modal-close-btn" class="text-2xl font-bold">&times;</button>
        </div>
        <div id="modal-content">
            <!-- –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
        </div>
        <div id="modal-footer" class="mt-6 flex justify-end space-x-4">
            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–º –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();

            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à URL –æ—Ç ngrok —Å—é–¥–∞
            const API_BASE_URL = "https://ea8d21bfaa8b.ngrok-free.app";

            const state = {
                initData: tg.initData,
                currentStatus: '–ù–æ–≤—ã–π',
                currentPage: 1,
                isLoading: false,
                orders: []
            };

            const ordersList = document.getElementById('orders-list');
            const loader = document.getElementById('loader');
            const loadingText = document.getElementById('loading-text');
            const tabButtons = document.querySelectorAll('.tab-button');
            const modal = document.getElementById('modal');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalFooter = document.getElementById('modal-footer');


            // --- –§—É–Ω–∫—Ü–∏–∏ API ---
            async function fetchApi(endpoint, options = {}) {
                if (!state.initData) {
                    tg.showAlert('–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.');
                    throw new Error('InitData is missing');
                }
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': state.initData,
                        ...options.headers,
                    },
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                return response.json();
            }

            async function loadOrders(status, page = 1) {
                if (state.isLoading) return;
                state.isLoading = true;
                loader.classList.remove('hidden');
                loadingText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...';
                ordersList.innerHTML = '';

                try {
                    const data = await fetchApi(`/api/orders?status=${status}&page=${page}&limit=10`);
                    state.orders = data.orders;
                    renderOrders(data.orders);
                    if (data.orders.length === 0) {
                        loadingText.textContent = '–ó–∞–∫–∞–∑–æ–≤ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç.';
                    } else {
                        loadingText.textContent = '';
                    }
                } catch (error) {
                    console.error('Failed to fetch orders:', error);
                    loadingText.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}.`;
                    tg.showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
                } finally {
                    state.isLoading = false;
                    loader.classList.add('hidden');
                }
            }

            async function updateOrderStatus(orderId, newStatus) {
                tg.showPopup({
                    title: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ',
                    message: `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ ‚Ññ${orderId} –Ω–∞ "${newStatus}"?`,
                    buttons: [
                        { id: 'ok', type: 'default', text: '–î–∞' },
                        { id: 'cancel', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞' },
                    ]
                }, async (buttonId) => {
                    if (buttonId === 'ok') {
                        try {
                            tg.showLoading();
                            await fetchApi(`/api/order/${orderId}/status`, {
                                method: 'POST',
                                body: JSON.stringify({ status: newStatus })
                            });
                            tg.showAlert(`–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ ‚Ññ${orderId} —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω.`);
                            closeModal();
                            loadOrders(state.currentStatus); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                        } catch (error) {
                            console.error('Failed to update order status:', error);
                            tg.showAlert(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${error.message}`);
                        } finally {
                            tg.hideLoading();
                        }
                    }
                });
            }


            // --- –§—É–Ω–∫—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ ---
            function renderOrders(orders) {
                ordersList.innerHTML = orders.map(order => `
                    <div class="order-card" data-order-id="${order.order_id}">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-lg">–ó–∞–∫–∞–∑ ‚Ññ${order.order_id}</p>
                            <p class="text-sm" style="color: var(--tg-hint);">${new Date(order.created_at).toLocaleString('ru-RU')}</p>
                        </div>
                        <p>–¢–∏–ø: ${order.order_type}</p>
                        <p>Telegram: ${order.user_telegram || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    </div>
                `).join('');

                document.querySelectorAll('.order-card').forEach(card => {
                    card.addEventListener('click', () => openModal(card.dataset.orderId));
                });
            }

            function formatDetailsForDisplay(details) {
                const keyMap = {
                    'gender': 'üë§ –ü–æ–ª –∫–ª–∏–µ–Ω—Ç–∞', 'recipient': 'üéÅ –î–ª—è –∫–æ–≥–æ', 'sender_role': 'üë• –û—Ç –∫–æ–≥–æ',
                    'occasion': 'üéâ –ü–æ–≤–æ–¥', 'years_together': 'üíû –õ–µ—Ç –≤–º–µ—Å—Ç–µ', 'has_children': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –î–µ—Ç–∏',
                    'song_style': 'üé∂ –°—Ç–∏–ª—å –ø–µ—Å–Ω–∏', 'wishes': '‚úçÔ∏è –ü–æ–∂–µ–ª–∞–Ω–∏—è',
                    'email': 'üìß Email', 'phone': 'üì± –¢–µ–ª–µ—Ñ–æ–Ω', 'telegram': '‚úàÔ∏è Telegram', 'source': 'üìç –ò—Å—Ç–æ—á–Ω–∏–∫'
                };
                let html = '<dl class="modal-content-grid">';
                for (const key in details) {
                    if (keyMap[key] && details[key]) {
                        html += `<dt>${keyMap[key]}</dt><dd>${details[key]}</dd>`;
                    }
                }
                html += '</dl>';
                return html;
            }

            async function openModal(orderId) {
                modalTitle.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–∞ ‚Ññ${orderId}...`;
                modalContent.innerHTML = '<div class="loader"></div>';
                modalFooter.innerHTML = '';
                modal.classList.remove('hidden');
                modalBackdrop.classList.remove('hidden');

                try {
                    const order = await fetchApi(`/api/order/${orderId}`);
                    modalTitle.textContent = `–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ ‚Ññ${order.order_id}`;

                    let contentHtml = `
                        <p class="mb-4"><strong style="color: var(--tg-hint);">–°—Ç–∞—Ç—É—Å:</strong> ${order.status}</p>
                        ${formatDetailsForDisplay(order.details)}
                    `;
                    modalContent.innerHTML = contentHtml;

                    let footerHtml = '';
                    if (order.status === '–ù–æ–≤—ã–π') {
                        footerHtml += `<button data-order-id="${order.order_id}" data-new-status="–í —Ä–∞–±–æ—Ç–µ" class="status-btn tab-active px-4 py-2 rounded-lg font-semibold">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>`;
                    }
                    if (order.status === '–í —Ä–∞–±–æ—Ç–µ') {
                        footerHtml += `<button data-order-id="${order.order_id}" data-new-status="–ó–∞–≤–µ—Ä—à–µ–Ω" class="status-btn tab-active px-4 py-2 rounded-lg font-semibold">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>`;
                    }
                    modalFooter.innerHTML = footerHtml;

                    document.querySelectorAll('.status-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            updateOrderStatus(btn.dataset.orderId, btn.dataset.newStatus);
                        });
                    });

                } catch (error) {
                    console.error('Failed to fetch order details:', error);
                    modalContent.innerHTML = `<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞: ${error.message}</p>`;
                }
            }

            // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---\
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const status = button.dataset.status;
                    if (state.currentStatus === status) return;

                    tabButtons.forEach(btn => {
                        btn.classList.remove('tab-active');
                        btn.classList.add('tab-inactive');
                    });
                    button.classList.add('tab-active');
                    button.classList.remove('tab-inactive');

                    state.currentStatus = status;
                    state.currentPage = 1;
                    loadOrders(status);
                });
            });

            function closeModal() {
                modal.classList.add('hidden');
                modalBackdrop.classList.add('hidden');
            }

            modalCloseBtn.addEventListener('click', closeModal);
            modalBackdrop.addEventListener('click', closeModal);

            // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
            if (!state.initData) {
                loadingText.textContent = "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ –±–æ—Ç–∞.";
                tg.showAlert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.");
                return;
            }

            loadOrders(state.currentStatus);
        });
    </script>

</body>
</html>
